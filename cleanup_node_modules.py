#!/usr/bin/env python3
"""
Node Modules Cleanup Script for Windows
Recursively scans D:\ drive for node_modules directories and removes them safely.
"""

import os
import shutil
import sys
from pathlib import Path


def get_directory_size(path):
    """
    Calculate the total size of a directory in bytes.
    
    Args:
        path: Path to the directory
        
    Returns:
        Total size in bytes, or 0 if calculation fails
    """
    total_size = 0
    try:
        for dirpath, dirnames, filenames in os.walk(path):
            for filename in filenames:
                file_path = os.path.join(dirpath, filename)
                try:
                    if os.path.exists(file_path):
                        total_size += os.path.getsize(file_path)
                except (OSError, PermissionError):
                    # Skip files we can't access
                    continue
    except (OSError, PermissionError):
        pass
    return total_size


def format_size(bytes_size):
    """
    Convert bytes to human-readable format.
    
    Args:
        bytes_size: Size in bytes
        
    Returns:
        Formatted string (e.g., "1.23 GB")
    """
    for unit in ['B', 'KB', 'MB', 'GB', 'TB']:
        if bytes_size < 1024.0:
            return f"{bytes_size:.2f} {unit}"
        bytes_size /= 1024.0
    return f"{bytes_size:.2f} PB"


def find_node_modules(root_path):
    """
    Recursively search for node_modules directories.
    
    Args:
        root_path: Root directory to start scanning
        
    Returns:
        List of tuples containing (path, size_in_bytes)
    """
    node_modules_dirs = []
    skipped_dirs = []
    
    print(f"\nðŸ” Scanning {root_path} for node_modules directories...")
    print("This may take a while depending on the size of your drive.\n")
    
    try:
        for dirpath, dirnames, filenames in os.walk(root_path, topdown=True):
            # Skip system-protected and special directories
            dirnames[:] = [d for d in dirnames if not is_protected_directory(os.path.join(dirpath, d))]
            
            # Check if current directory contains node_modules
            if 'node_modules' in dirnames:
                node_modules_path = os.path.join(dirpath, 'node_modules')
                try:
                    print(f"Found: {node_modules_path}")
                    size = get_directory_size(node_modules_path)
                    node_modules_dirs.append((node_modules_path, size))
                    
                    # Remove node_modules from dirnames to prevent descending into it
                    dirnames.remove('node_modules')
                except PermissionError:
                    skipped_dirs.append(node_modules_path)
                    print(f"âš ï¸  Permission denied: {node_modules_path}")
                    dirnames.remove('node_modules')
                except Exception as e:
                    skipped_dirs.append(node_modules_path)
                    print(f"âš ï¸  Error accessing {node_modules_path}: {e}")
                    dirnames.remove('node_modules')
    
    except PermissionError as e:
        print(f"âš ï¸  Permission denied for root directory: {e}")
    except Exception as e:
        print(f"âŒ Error during scan: {e}")
    
    if skipped_dirs:
        print(f"\nâš ï¸  Skipped {len(skipped_dirs)} directories due to permissions or errors.")
    
    return node_modules_dirs


def is_protected_directory(path):
    """
    Check if a directory is system-protected or should be skipped.
    
    Args:
        path: Directory path to check
        
    Returns:
        True if directory should be skipped, False otherwise
    """
    # Common Windows system directories to skip
    protected_dirs = {
        'Windows', 'Program Files', 'Program Files (x86)', 
        'ProgramData', 'System Volume Information',
        '$Recycle.Bin', 'Recovery', 'PerfLogs',
        'Boot', 'Documents and Settings', 'Config.Msi'
    }
    
    try:
        dir_name = os.path.basename(path)
        
        # Skip hidden and system directories
        if os.path.exists(path):
            import stat
            attrs = os.stat(path).st_file_attributes if hasattr(os.stat(path), 'st_file_attributes') else 0
            # FILE_ATTRIBUTE_HIDDEN = 2, FILE_ATTRIBUTE_SYSTEM = 4
            if attrs & 2 or attrs & 4:
                return True
        
        # Skip known protected directories
        if dir_name in protected_dirs:
            return True
            
    except (OSError, PermissionError, AttributeError):
        return True
    
    return False


def delete_node_modules(directories):
    """
    Delete the specified node_modules directories.
    
    Args:
        directories: List of tuples (path, size)
        
    Returns:
        Tuple of (deleted_count, freed_space, failed_deletions)
    """
    deleted_count = 0
    freed_space = 0
    failed_deletions = []
    
    print("\nðŸ—‘ï¸  Starting deletion process...\n")
    
    for path, size in directories:
        try:
            print(f"Deleting: {path} ({format_size(size)})")
            shutil.rmtree(path, ignore_errors=False)
            deleted_count += 1
            freed_space += size
            print(f"âœ“ Successfully deleted")
        except PermissionError:
            failed_deletions.append((path, "Permission denied"))
            print(f"âœ— Permission denied")
        except Exception as e:
            failed_deletions.append((path, str(e)))
            print(f"âœ— Failed: {e}")
    
    return deleted_count, freed_space, failed_deletions


def main():
    """Main function to orchestrate the cleanup process."""
    
    print("=" * 70)
    print("Node Modules Cleanup Script for Windows")
    print("=" * 70)
    
    # Define the root path
    root_path = "D:\\"
    
    # Check if D:\ exists
    if not os.path.exists(root_path):
        print(f"\nâŒ Error: Drive {root_path} does not exist or is not accessible.")
        sys.exit(1)
    
    # Find all node_modules directories
    node_modules_dirs = find_node_modules(root_path)
    
    if not node_modules_dirs:
        print("\nâœ“ No node_modules directories found.")
        return
    
    # Display findings
    print("\n" + "=" * 70)
    print(f"ðŸ“Š SCAN RESULTS")
    print("=" * 70)
    print(f"\nFound {len(node_modules_dirs)} node_modules directories:\n")
    
    total_size = 0
    for idx, (path, size) in enumerate(node_modules_dirs, 1):
        print(f"{idx}. {path}")
        print(f"   Size: {format_size(size)}")
        total_size += size
    
    print(f"\n{'â”€' * 70}")
    print(f"Total space occupied: {format_size(total_size)}")
    print("=" * 70)
    
    # Ask for confirmation
    print("\nâš ï¸  WARNING: This will permanently delete the above directories!")
    while True:
        response = input("\nDo you want to proceed with deletion? (yes/no): ").strip().lower()
        if response in ['yes', 'y']:
            break
        elif response in ['no', 'n']:
            print("\nâŒ Operation cancelled by user.")
            return
        else:
            print("Please enter 'yes' or 'no'.")
    
    # Perform deletion
    deleted_count, freed_space, failed_deletions = delete_node_modules(node_modules_dirs)
    
    # Display summary
    print("\n" + "=" * 70)
    print("ðŸ“ˆ SUMMARY")
    print("=" * 70)
    print(f"\nTotal node_modules folders found: {len(node_modules_dirs)}")
    print(f"Successfully deleted: {deleted_count}")
    print(f"Failed to delete: {len(failed_deletions)}")
    print(f"Total disk space freed: {format_size(freed_space)}")
    
    if failed_deletions:
        print("\nâŒ Failed deletions:")
        for path, reason in failed_deletions:
            print(f"   {path}")
            print(f"   Reason: {reason}")
    
    print("\nâœ“ Cleanup process completed!")
    print("=" * 70)


if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        print("\n\nâŒ Operation cancelled by user (Ctrl+C).")
        sys.exit(1)
    except Exception as e:
        print(f"\nâŒ Unexpected error: {e}")
        sys.exit(1)
